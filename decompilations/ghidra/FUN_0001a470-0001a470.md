```c
void setOptimalFrequency(float targetFrequency, uint32_t chainIndex, uint32_t voltageLevel, bool isHigherVoltage) {
  uint32_t *pFrequencySetting;
  uint16_t *pCalculationVar;
  byte *pChainVar;
  byte varHelper;
  uint32_t varCounter;
  uint32_t varCounter2;
  size_t sortedIndex;
  uint32_t varValueOne;
  uint32_t varValueTwo;
  size_t settingCount;
  int calculationResult;
  uint32_t finalFrequency;
  uint32_t topVarValue;
  size_t optimalFreqSettingsSize;
  byte buffer4[4];
  uint32_t calculatedFreq;
  uint32_t flags;
  uint16_t optimalFreqSettings[100];
  uint32_t tempStorage32;
  uint32_t tempStackStorage32;
  
  if (DEBUG_LEVEL > 3) {
    const char *isHigherVoltageStr = isHigherVoltage ? "true" : "false";
    snprintf((char *)&tempStorage32, 0x800, "chain = %d, freq = %g, is_higher_voltage = %s\n", chainIndex, 
             (double)targetFrequency, isHigherVoltageStr);
    logDebug(3, &tempStorage32, 0);
  }
  
  initializeChainAtIndex(chainIndex, 1, 0, voltageLevel);
  
  calculatedFreq = 0;
  flags = 0;
  memset(optimalFreqSettings, 0, sizeof(optimalFreqSettings));
  calculateFrequency(targetFrequency, &calculatedFreq, buffer4, 0);

  finalFrequency = calculatedFreq & 0xff;
  topVarValue = (uint32_t)buffer4[0];
  varValueOne = calculatedFreq >> 8;
  varValueTwo = DEBUG_LEVEL;

  if (finalFrequency < 8) {
    optimalFreqSettingsSize = 0;
    varCounter2 = varValueOne;
    topVarValue = finalFrequency;
    do {
      while (varCounter = varCounter2 & 0xff, varCounter <= topVarValue) {
        if (topVarValue < 2) {
          pCalculationVar = optimalFreqSettings + optimalFreqSettingsSize * 4;
          calculationResult = varCounter * finalFrequency * topVarValue;
          varValueTwo = topVarValue;
          do {
            *(char *)pCalculationVar = (char)topVarValue;
            *(char *)((int)pCalculationVar + 1) = (char)varCounter2;
            *(char *)(pCalculationVar + 1) = (char)varValueTwo;
            *(int *)(pCalculationVar + 2) = calculationResult;
            if (DEBUG_LEVEL > 4) {
              snprintf((char *)&tempStorage32, 0x800,
                       "post_div1 = %d, post_div2 = %d, user_div = %d, div_ret = %d\n", finalFrequency, 
                       varCounter, varValueTwo, calculationResult);
              logDebug(4, &tempStorage32, 0);
              varValueTwo = DEBUG_LEVEL;
            }
            varValueTwo = varValueTwo + 1;
            pCalculationVar = pCalculationVar + 4;
            calculationResult = calculationResult + varCounter * finalFrequency;
          } while ((varValueTwo & 0xff) < 2);
          optimalFreqSettingsSize = optimalFreqSettingsSize + (1 - topVarValue & 0xff) + 1;
        }
        varCounter2 = varCounter + 1;
      }
      finalFrequency = finalFrequency + 1;
      topVarValue = finalFrequency & 0xff;
      varCounter2 = varValueOne;
    } while (topVarValue < 8);
  }
  else {
    optimalFreqSettingsSize = 0;
  }

  if (DEBUG_LEVEL > 4) {
    // Logging the sorted frequency settings data
    logSortedFreqSettings(DEBUG_LEVEL, &tempStorage32);
  }

  // Sort the optimal frequency settings based on criteria
  qsort(optimalFreqSettings, optimalFreqSettingsSize, 8, frequencyCompareFunction);

  // Iterate through the sorted frequency settings
  if (optimalFreqSettingsSize != 0) {
    sortedIndex = 0;
    pCalculationVar = optimalFreqSettings;
    do {
      logFrequencySettings(DEBUG_LEVEL, pCalculationVar, &tempStorage32, sortedIndex, optimalFreqSettingsSize);
      sortedIndex++;
      pCalculationVar += 4;
    } while (sortedIndex < optimalFreqSettingsSize);

    // Apply the sorted frequency settings
    settingCount = 0;
    pCalculationVar = optimalFreqSettings;
    do {
      flags = CONCAT22(flags, *pCalculationVar) & 0x00FFFFFF;
      calculatedFreq = CONCAT22(calculatedFreq & 0xFFFF0000, *(pCalculationVar + 1));
      varValueOne = applyFrequencySettings(calculatedFreq, flags);
      if (THRESHOLD_FREQ < varValueOne) {
        logFinalFrequencySettings(DEBUG_LEVEL, &tempStorage32, settingCount, calculatedFreq, flags, varValueOne);
        forceRelockPLL(chainIndex, 1, 0, voltageLevel);
        usleep(1000000);  // Wait for 1 second
      }
      settingCount++;
      pCalculationVar += 4;
    } while (settingCount != sortedIndex);
  }

  return;
}
```